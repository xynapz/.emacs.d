#+TITLE: Evil Mode
#+AUTHOR: Angel Dhakal
#+STARTUP: overview
#+OPTIONS: toc:2

* Config

Located in =lisp/xz-evil.el=.

| Package          | Purpose            |
|------------------+--------------------|
| evil             | Core vim emulation |
| evil-collection  | Mode-specific keys |
| evil-surround    | cs/ds/ys ops       |
| evil-commentary  | gc to comment      |

* Settings

| Setting                    | Value                |
|----------------------------+----------------------|
| =evil-want-C-u-scroll=     | t (C-u = half up)    |
| =evil-want-C-d-scroll=     | t (C-d = half down)  |
| =evil-want-Y-yank-to-eol=  | t (Y = y$)           |
| =evil-esc-delay=           | 0 (instant ESC)      |
| =evil-want-fine-undo=      | t (granular undo)    |
| =evil-split-window-below=  | t                    |
| =evil-vsplit-window-right= | t                    |

* Cursor Colors

| State   | Cursor  | Color   |
|---------+---------+---------|
| Normal  | Box     | Green   |
| Insert  | Bar     | Amber   |
| Visual  | Hollow  | Cyan    |
| Replace | H-bar   | Magenta |
| Emacs   | Box     | Red     |

* Escape Methods

| Key   | Action             |
|-------+--------------------|
| =ESC= | Exit to normal     |
| =C-[= | Same as ESC        |
| =jk=  | Exit insert (fast) |

Type =j= then =k= within 150ms to escape.

* Commentary (gc)

| Keys  | Action              |
|-------+---------------------|
| =gcc= | Comment line        |
| =gc3j= | Comment 3 lines down |
| =gcap= | Comment paragraph   |
| =gc=  | Comment selection (visual) |

* Registers

| Key        | Action                 |
|------------+------------------------|
| ="ay=      | Yank to register a     |
| ="ap=      | Paste from register a  |
| ="+y=      | Yank to system clipboard |
| ="+p=      | Paste from clipboard   |
| =:reg=     | List registers         |

Special registers:
- ="= - Default (last yank/delete)
- =+= - System clipboard
- =0= - Last yank only
- =1-9= - Delete history

* Evil in Buffers

Evil-collection provides vim bindings everywhere.

** Dired

| Key | Action           |
|-----+------------------|
| =j= | Down             |
| =k= | Up               |
| =h= | Up directory     |
| =l= | Enter/open       |
| =gg= | Top             |
| =G= | Bottom           |
| =o= | Open other window |
| =s= | Sort             |
| =m= | Mark             |
| =u= | Unmark           |
| =d= | Flag delete      |
| =x= | Execute flags    |
| =R= | Rename           |
| =C= | Copy             |
| =+= | Create directory |
| =q= | Quit             |

** Magit

| Key   | Action          |
|-------+-----------------|
| =j=   | Down            |
| =k=   | Up              |
| =TAB= | Expand/collapse |
| =RET= | Visit           |
| =s=   | Stage           |
| =u=   | Unstage         |
| =c c= | Commit          |
| =P p= | Push            |
| =F p= | Pull            |
| =b b= | Checkout branch |
| =b c= | Create branch   |
| =l l= | Log             |
| =d d= | Diff            |
| =z z= | Stash           |
| =q=   | Quit            |
| =g=   | Refresh         |

** Help / Info

| Key | Action           |
|-----+------------------|
| =j= | Down             |
| =k= | Up               |
| =h= | Back             |
| =l= | Forward / follow |
| =gg= | Top             |
| =G= | Bottom           |
| =q= | Quit             |
| =/= | Search           |
| =n= | Next match       |

** Compilation

| Key | Action         |
|-----+----------------|
| =j= | Down           |
| =k= | Up             |
| =g= | Recompile      |
| =q= | Quit           |
| =RET= | Go to error  |

** Buffer Menu (ibuffer)

| Key | Action       |
|-----+--------------|
| =j= | Down         |
| =k= | Up           |
| =d= | Mark delete  |
| =x= | Execute      |
| =m= | Mark         |
| =u= | Unmark       |
| =RET= | Visit      |
| =o= | Other window |
| =q= | Quit         |

** Package Menu

| Key | Action       |
|-----+--------------|
| =j= | Down         |
| =k= | Up           |
| =i= | Mark install |
| =d= | Mark delete  |
| =x= | Execute      |
| =U= | Mark upgrade |
| =RET= | Describe   |
| =q= | Quit         |

** Minibuffer

Evil enabled in minibuffer (=evil-collection-setup-minibuffer=).

| Key   | Action              |
|-------+---------------------|
| =C-j= | Next candidate      |
| =C-k= | Previous candidate  |
| =C-n= | Next (alt)          |
| =C-p= | Previous (alt)      |
| =RET= | Select              |
| =C-g= | Cancel              |
| =ESC= | Cancel (normal)     |

** Org Mode

| Key   | Action                |
|-------+-----------------------|
| =TAB= | Fold/unfold           |
| =za=  | Toggle fold           |
| =zc=  | Close fold            |
| =zo=  | Open fold             |
| =zM=  | Close all             |
| =zR=  | Open all              |
| =gj=  | Next heading          |
| =gk=  | Previous heading      |
| =M-j= | Move subtree down     |
| =M-k= | Move subtree up       |
| =M-h= | Promote               |
| =M-l= | Demote                |

** Term / Eshell

Shell modes use emacs state by default.
Use =C-z= to toggle evil on/off in terminal.

| Key   | Action         |
|-------+----------------|
| =C-z= | Toggle evil    |
| =i=   | Insert (if evil on) |

* Troubleshooting

** Keybindings not working

1. Check mode: =M-x describe-mode=
2. Check key: =C-h k= then press key
3. Reload: =M-x evil-mode= twice

** Wrong cursor in terminal

Add to shell config:
#+begin_src sh
# .zshrc or .bashrc
echo -ne '\e[2 q'  # block cursor
#+end_src

** Clipboard not working

Install =xclip= or =wl-copy=:
#+begin_src sh
sudo dnf install xclip wl-clipboard
#+end_src

Use ="+y= and ="+p= for system clipboard.
